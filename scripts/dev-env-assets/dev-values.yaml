# Development values for haproxy-template-ic Helm chart

# Use local development image
image:
  repository: haproxy-template-ic
  tag: dev
  pullPolicy: Never  # Never pull, always use local image

# Enable Gateway API support for development
controller:
  templateLibraries:
    gateway:
      enabled: true

  config:
    logging:
      verbose: 2  # DEBUG level

    templatingSettings:
      extraContext:
        debug: true  # Enable introspection headers for development

    # HTTP Store Demo: Block requests based on header values from HTTP-fetched blocklist
    maps:
      header-blocklist.map:
        template: |
          {%- set blocklist_url = "http://blocklist-server.echo.svc:80/blocklist.txt" -%}
          {%- set blocklist_content = http.Fetch(blocklist_url, {"critical": true, "delay": "60s"}) -%}
          {%- for line in blocklist_content.split("\n") -%}
          {%- set value = line | trim -%}
          {%- if value != "" -%}
          {{ value }} 1{{ "\n" }}
          {%- endif -%}
          {%- endfor %}

    templateSnippets:
      # Hook into frontend routing to check header against blocklist
      # Uses "frontend-filters-*" naming convention to be auto-included by base.yaml
      frontend-filters-http-store-demo:
        template: |
          # HTTP Store Demo: Block requests with blacklisted header values
          http-request deny deny_status 403 if { req.hdr(X-Custom-Header) -m found } { req.hdr(X-Custom-Header),map({{ pathResolver.GetPath("header-blocklist.map", "map") }}) -m found }

# HAProxy Service - expose externally via NodePort for dev/testing
haproxy:
  service:
    type: NodePort
    # Explicit NodePorts must be set to match kind extraPortMappings
    http:
      nodePort: 30080
    https:
      nodePort: 30443
    stats:
      nodePort: 30404
  # kind cluster maps NodePort services to localhost via extraPortMappings
  # This makes HAProxy accessible at http://localhost:30080 and https://localhost:30443

  # Enable network policies in dev with permissive settings
  networkPolicy:
    enabled: true
    allowExternal: true  # Allow NodePort access from host

# Resource limits for development (allow more flexibility)
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# Disable autoscaling for development (fixed replica count)
autoscaling:
  enabled: false

networkPolicy:
  enabled: true

# Development-specific pod labels for easier identification
podLabels:
  environment: development
  managed-by: dev-script

# Disable health probes until /healthz endpoint is implemented
livenessProbe: {}
readinessProbe: {}

# Disable monitoring for simpler development setup
monitoring:
  serviceMonitor:
    enabled: false

# Enable webhook for development testing
webhook:
  enabled: true
  # secretName defaults to: {{ include "haproxy-template-ic.fullname" . }}-webhook-cert
  certManager:
    enabled: false  # Use manual certificates generated by dev script
  # CA bundle will be set dynamically by dev script via --set webhook.caBundle=...
