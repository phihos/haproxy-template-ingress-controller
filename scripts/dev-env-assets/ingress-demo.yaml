# HAProxy Template Ingress Controller - Comprehensive Annotation Examples
# This file demonstrates all supported haproxy.org/* annotations
# Deploy with: kubectl apply -f ingress-demo.yaml
# Test with: ./scripts/test-routes.sh

---
# Supporting Resources - Basic Auth Secret
apiVersion: v1
kind: Secret
metadata:
  name: echo-auth-secret
  namespace: echo
type: Opaque
data:
  # Username: admin, Password: admin (bcrypt hash)
  # Generated with: htpasswd -nbB admin admin | cut -d: -f2 | base64 -w0
  admin: JDJ5JDA1JG1OMVdWazVRbmJnNFF3ZEFkWGJmei44YjNjZUg2UTVLT1ZDS3hSMklrTkFmSmdMaTVwSUtX

---
##############################################################################
# 1. BASIC INGRESS - No annotations (baseline)
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-basic
  namespace: echo
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 2. BASIC AUTHENTICATION
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-auth
  namespace: echo
  annotations:
    haproxy.org/auth-type: "basic-auth"
    haproxy.org/auth-secret: "echo-auth-secret"
    haproxy.org/auth-realm: "Echo-Server-Protected"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-auth.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 3. CORS CONFIGURATION
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-cors
  namespace: echo
  annotations:
    haproxy.org/cors-enable: "true"
    haproxy.org/cors-allow-origin: "https://example.com"
    haproxy.org/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    haproxy.org/cors-allow-headers: "Content-Type, Authorization, X-Custom-Header"
    haproxy.org/cors-allow-credentials: "true"
    haproxy.org/cors-max-age: "3600"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-cors.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 4. RATE LIMITING
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-ratelimit
  namespace: echo
  annotations:
    haproxy.org/rate-limit-requests: "5"
    haproxy.org/rate-limit-period: "10s"
    haproxy.org/rate-limit-size: "100k"
    haproxy.org/rate-limit-status-code: "429"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-ratelimit.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 5. IP ACCESS CONTROL - Allowlist
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-allowlist
  namespace: echo
  annotations:
    # Allow only specific IPs/CIDRs (localhost and cluster internal)
    haproxy.org/allowlist: "127.0.0.1, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-allowlist.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 6. IP ACCESS CONTROL - Denylist
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-denylist
  namespace: echo
  annotations:
    # Deny specific IPs (example - would deny 1.1.1.1)
    haproxy.org/denylist: "1.1.1.1, 8.8.8.8"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-denylist.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 7. REQUEST REDIRECT
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-redirect
  namespace: echo
  annotations:
    haproxy.org/request-redirect: "https://echo.localdev.me"
    haproxy.org/request-redirect-code: "302"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-redirect.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 8. HEADER MANIPULATION - Request Headers
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-headers-request
  namespace: echo
  annotations:
    haproxy.org/request-set-header: |
      X-Forwarded-Proto https
      X-Custom-Request custom-req-value
      X-Request-ID req-12345
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-headers-request.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 9. HEADER MANIPULATION - Response Headers
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-headers-response
  namespace: echo
  annotations:
    haproxy.org/response-set-header: |
      Strict-Transport-Security max-age=31536000
      X-Custom-Response custom-resp-value
      X-Frame-Options DENY
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-headers-response.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 10. SET HOST HEADER
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-sethost
  namespace: echo
  annotations:
    haproxy.org/set-host: "internal-api.example.svc.cluster.local"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-sethost.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 11. PATH REWRITE
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-rewrite
  namespace: echo
  annotations:
    # Rewrite /api/v1/* to /*
    haproxy.org/path-rewrite: "^/api/v1/(.*) /\\1"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-rewrite.localdev.me
      http:
        paths:
          - path: /api/v1
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 12. LOAD BALANCING ALGORITHM
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-loadbalance
  namespace: echo
  annotations:
    haproxy.org/load-balance: "leastconn"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-loadbalance.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 13. COOKIE PERSISTENCE (Sticky Sessions)
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-sticky
  namespace: echo
  annotations:
    haproxy.org/cookie-persistence: "SERVERID"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-sticky.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 14. TIMEOUTS CONFIGURATION
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-timeouts
  namespace: echo
  annotations:
    haproxy.org/timeout-server: "30s"
    haproxy.org/timeout-client: "60s"
    haproxy.org/timeout-connect: "10s"
    haproxy.org/timeout-http-request: "5s"
    haproxy.org/timeout-http-keep-alive: "2m"
    haproxy.org/timeout-queue: "15s"
    haproxy.org/timeout-tunnel: "1h"
    haproxy.org/timeout-check: "3s"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-timeouts.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 15. FORWARDED-FOR HEADER
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-forwardedfor
  namespace: echo
  annotations:
    haproxy.org/forwarded-for: "true"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-forwardedfor.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 16. REQUEST CAPTURE (Logging)
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-capture
  namespace: echo
  annotations:
    haproxy.org/request-capture: |
      User-Agent
      Referer
      Cookie
    haproxy.org/request-capture-len: "256"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-capture.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 17. CUSTOM HEALTH CHECKS
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-healthcheck
  namespace: echo
  annotations:
    haproxy.org/check: "true"
    haproxy.org/check-http: "GET /health"
    haproxy.org/check-interval: "10s"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-healthcheck.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 18. POD MAXCONN (Connection Limits)
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-maxconn
  namespace: echo
  annotations:
    haproxy.org/pod-maxconn: "100"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-maxconn.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 19. SOURCE IP HEADER (Behind CDN/Proxy)
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-srcip
  namespace: echo
  annotations:
    haproxy.org/src-ip-header: "CF-Connecting-IP"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-srcip.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 20. COMBINED ANNOTATIONS - Real-world example
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-combined
  namespace: echo
  annotations:
    # Security
    haproxy.org/auth-type: "basic-auth"
    haproxy.org/auth-secret: "echo-auth-secret"
    haproxy.org/allowlist: "10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16"
    # Rate limiting
    haproxy.org/rate-limit-requests: "100"
    haproxy.org/rate-limit-period: "1m"
    # Headers
    haproxy.org/response-set-header: |
      X-Frame-Options DENY
      X-Content-Type-Options nosniff
    # Performance
    haproxy.org/load-balance: "leastconn"
    haproxy.org/cookie-persistence: "SERVERID"
    haproxy.org/timeout-server: "30s"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-combined.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 21. BACKEND CONFIG SNIPPET - Raw HAProxy Configuration
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-backend-snippet
  namespace: echo
  annotations:
    haproxy.org/backend-config-snippet: |
      # Custom HAProxy backend configuration
      option httplog
      option http-keep-alive
      http-reuse safe
      # Custom ACL and routing
      acl is_api path_beg /api
      http-request set-header X-Backend-Type "api" if is_api
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-backend-snippet.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 22. SSL REDIRECT - Force HTTPS
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-ssl-redirect
  namespace: echo
  annotations:
    haproxy.org/ssl-redirect: "true"
    haproxy.org/ssl-redirect-code: "301"
    haproxy.org/ssl-redirect-port: "443"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-ssl-redirect.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 23. PROXY PROTOCOL - Preserve client connection info
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-proxy-protocol
  namespace: echo
  annotations:
    # Enable PROXY protocol v2 when connecting to backends
    haproxy.org/send-proxy-protocol: "proxy-v2"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-proxy-protocol.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 24. BACKEND SSL/TLS - Use HTTPS to backend + HTTP/2
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-backend-ssl
  namespace: echo
  annotations:
    # Enable SSL/TLS when connecting to backend (for backends that require HTTPS)
    haproxy.org/server-ssl: "true"
    # Use HTTP/2 protocol to backend
    haproxy.org/server-proto: "h2"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-backend-ssl.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

---
##############################################################################
# 25. SCALE SERVER SLOTS - Pre-allocate slots for dynamic scaling
##############################################################################
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-scale-slots
  namespace: echo
  annotations:
    # Pre-allocate 20 server slots (allows scaling without HAProxy reload)
    haproxy.org/scale-server-slots: "20"
spec:
  ingressClassName: haproxy-template-ic
  rules:
    - host: echo-scale-slots.localdev.me
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: echo-server
                port:
                  number: 80

##############################################################################
# 26. Backend mTLS (Mutual TLS to backend servers)
#
# Demonstrates using client certificates and CA verification for backend
# connections, enabling mutual TLS authentication between HAProxy and
# backend servers.
#
# Features:
# - server-ssl: Enable SSL/TLS to backend
# - server-ca: CA certificate for backend verification
# - server-crt: Client certificate for mTLS authentication
#
# Note: Secrets contain self-signed demo certificates. The echo-server
# backend does not support mTLS, so this demo only validates that the
# annotations are accepted and the HAProxy config is properly generated.
# In production, use real certificates and mTLS-capable backend servers.
#
