# Gateway API demonstration resources for HAProxy Template Ingress Controller
# This file demonstrates HTTPRoute capabilities including:
# - Basic path-based routing
# - Path matching variants (Exact, PathPrefix)
# - Traffic splitting with weighted backends
# - HTTP method matching (GET, POST, etc.)
# - Header matching (exact and regex)
# - Query parameter matching (exact and regex)
#
# Prerequisites:
# - Gateway API CRDs must be installed
# - Gateway library must be enabled in controller config
# - echo-server service must exist
#
# Debug Headers:
# When config.debug.headers.enabled is true (as in dev environment), HAProxy adds
# response headers showing internal routing decisions:
#
#   X-HAProxy-Backend            - Selected backend name (e.g., "gtw_echo_echo-split_echo-server_80")
#   X-HAProxy-Host-Match         - Matched hostname from host.map
#   X-HAProxy-Path-Match         - Path match result with qualifier (e.g., "BACKEND:...")
#   X-HAProxy-Path-Match-Qualifier - Match qualifier type (BACKEND, MULTIBACKEND, VAR)
#   X-HAProxy-Total-Weight       - Total weight for MULTIBACKEND routes
#   X-HAProxy-Random-Weight      - Random weight selected for traffic split
#   X-HAProxy-Route-Key          - Route key for weighted routing
#   X-Gateway-Matched-Route      - Gateway route that matched (e.g., "echo/echo-split/rule0")
#   X-Gateway-Match-Reason       - Types of matchers used (e.g., "method,header,query")
#   X-Gateway-Filters-Applied    - Filters applied (e.g., "RequestHeaderModifier,ResponseHeaderModifier")
#
# Inspect headers with:
#   curl -I http://echo-gateway.localdev.me/path

---
# Base Gateway resource that HTTPRoutes will attach to
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: dev-gateway
  namespace: echo
spec:
  gatewayClassName: haproxy
  listeners:
    - name: http
      protocol: HTTP
      port: 80

---
# HTTPRoute 1: Basic path-based routing
# Demonstrates: Simple PathPrefix matching with single backend
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo-basic
  namespace: echo
spec:
  parentRefs:
    - name: dev-gateway
  hostnames:
    - "echo-gateway.localdev.me"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: echo-server
          port: 80

---
# HTTPRoute 2: Path matching variants
# Demonstrates: Exact and PathPrefix matching on different paths
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo-paths
  namespace: echo
spec:
  parentRefs:
    - name: dev-gateway
  hostnames:
    - "echo-paths.localdev.me"
  rules:
    # Exact path match - only matches /exact, not /exact/foo
    - matches:
        - path:
            type: Exact
            value: /exact
      backendRefs:
        - name: echo-server
          port: 80
    # PathPrefix match - matches /api, /api/, /api/foo, etc.
    - matches:
        - path:
            type: PathPrefix
            value: /api
      backendRefs:
        - name: echo-server
          port: 80
    # Default catch-all for other paths
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: echo-server
          port: 80

---
# HTTPRoute 3: Traffic splitting with weighted backends
# Demonstrates: Weighted routing to multiple backends (70/30 split)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo-split
  namespace: echo
spec:
  parentRefs:
    - name: dev-gateway
  hostnames:
    - "echo-split.localdev.me"
  rules:
    - backendRefs:
        # 70% of traffic goes to primary echo-server
        - name: echo-server
          port: 80
          weight: 70
        # 30% of traffic goes to echo-server-v2
        - name: echo-server-v2
          port: 80
          weight: 30

---
# Second echo server variant for traffic splitting demonstration
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-server-v2
  namespace: echo
  labels:
    app: echo-server-v2
    variant: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: echo-server-v2
      variant: v2
  template:
    metadata:
      labels:
        app: echo-server-v2
        variant: v2
    spec:
      containers:
        - name: server
          image: ealen/echo-server:latest
          imagePullPolicy: IfNotPresent
          env:
            # Set environment variable to distinguish v2 in responses
            - name: ENVIRONMENT
              value: "v2"
          ports:
            - containerPort: 80

---
# Service for echo-server-v2
apiVersion: v1
kind: Service
metadata:
  name: echo-server-v2
  namespace: echo
  labels:
    app: echo-server-v2
    variant: v2
spec:
  selector:
    app: echo-server-v2
    variant: v2
  ports:
    - name: http
      port: 80
      targetPort: 80

---
# HTTPRoute 4: HTTP method matching
# Demonstrates: Routing based on HTTP methods (GET vs POST)
# Test with: curl -X GET http://localhost:30080/api -H "Host: echo-methods.localdev.me"
#            curl -X POST http://localhost:30080/api -H "Host: echo-methods.localdev.me"
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo-methods
  namespace: echo
spec:
  parentRefs:
    - name: dev-gateway
  hostnames:
    - "echo-methods.localdev.me"
  rules:
    # Route POST requests to primary echo-server
    - matches:
        - path:
            type: PathPrefix
            value: /api
          method: POST
      backendRefs:
        - name: echo-server
          port: 80
    # Route GET requests to v2 echo-server
    - matches:
        - path:
            type: PathPrefix
            value: /api
          method: GET
      backendRefs:
        - name: echo-server-v2
          port: 80
    # Default for other methods
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: echo-server
          port: 80

---
# HTTPRoute 5: Header matching (exact and regex)
# Demonstrates: Routing based on request headers
# Test with: curl http://localhost:30080 -H "Host: echo-headers.localdev.me" -H "X-Api-Version: v2"
#            curl http://localhost:30080 -H "Host: echo-headers.localdev.me" -H "X-User-Agent: mobile-app-ios"
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo-headers
  namespace: echo
spec:
  parentRefs:
    - name: dev-gateway
  hostnames:
    - "echo-headers.localdev.me"
  rules:
    # Exact header match: X-Api-Version: v2
    - matches:
        - headers:
            - type: Exact
              name: X-Api-Version
              value: v2
      backendRefs:
        - name: echo-server-v2
          port: 80
    # Regex header match: X-User-Agent contains "mobile"
    - matches:
        - headers:
            - type: RegularExpression
              name: X-User-Agent
              value: ".*mobile.*"
      backendRefs:
        - name: echo-server-v2
          port: 80
    # Default for requests without special headers
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: echo-server
          port: 80

---
# HTTPRoute 6: Query parameter matching
# Demonstrates: Routing based on query parameters
# Test with: curl "http://localhost:30080/search?version=beta" -H "Host: echo-query.localdev.me"
#            curl "http://localhost:30080/search?debug=true" -H "Host: echo-query.localdev.me"
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo-query
  namespace: echo
spec:
  parentRefs:
    - name: dev-gateway
  hostnames:
    - "echo-query.localdev.me"
  rules:
    # Exact query param match: version=beta
    - matches:
        - queryParams:
            - type: Exact
              name: version
              value: beta
      backendRefs:
        - name: echo-server-v2
          port: 80
    # Regex query param match: debug parameter with any true-ish value
    - matches:
        - queryParams:
            - type: RegularExpression
              name: debug
              value: "^(true|1|yes)$"
      backendRefs:
        - name: echo-server-v2
          port: 80
    # Default for requests without special query params
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: echo-server
          port: 80

---
# HTTPRoute 7: Combined matchers
# Demonstrates: Multiple matcher types in a single rule (method + headers + query)
# Test with: curl -X POST "http://localhost:30080/api?token=secret123" \
#              -H "Host: echo-combined.localdev.me" \
#              -H "Content-Type: application/json"
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo-combined
  namespace: echo
spec:
  parentRefs:
    - name: dev-gateway
  hostnames:
    - "echo-combined.localdev.me"
  rules:
    # Complex rule: POST + Content-Type header + token query param
    - matches:
        - path:
            type: PathPrefix
            value: /api
          method: POST
          headers:
            - type: Exact
              name: Content-Type
              value: application/json
          queryParams:
            - type: RegularExpression
              name: token
              value: "^secret[0-9]+$"
      backendRefs:
        - name: echo-server-v2
          port: 80
    # Default fallback
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: echo-server
          port: 80

---
# HTTPRoute 8: Conflict resolution via precedence
# Demonstrates: Gateway API precedence when multiple rules match the same path
#
# Gateway API Precedence Rules (applied in order):
#   1. Path type (Exact > PathPrefix)
#   2. Path length (longer > shorter)
#   3. Method matcher exists (with method > without)
#   4. Number of header matchers (more > fewer)
#   5. Number of query param matchers (more > fewer)
#   6. Creation timestamp (older > newer)
#   7. Namespace/name (alphabetically)
#   8. Rule index (lower > higher)
#
# All rules below have the SAME path (/) - precedence is determined by matchers.
# Rules are intentionally declared in RANDOM order to demonstrate HAProxy's sorting.
#
# Expected order after sorting (most to least specific):
#   Rule 2: GET + 2 headers + 1 query → echo-server-v2
#   Rule 0: GET + 1 header → echo-server
#   Rule 3: GET only → echo-server-v2
#   Rule 1: No matchers (catch-all) → echo-server
#
# Test commands:
#   # Rule 2 (most specific): GET + X-Version + X-Environment + debug=true
#   curl -I "http://localhost:30080/?debug=true" \
#     -H "Host: echo-precedence.localdev.me" \
#     -H "X-Version: v2" \
#     -H "X-Environment: prod"
#   # Should route to echo-server-v2, X-Gateway-Matched-Route: echo/echo-precedence/rule2
#
#   # Rule 0: GET + X-Version only
#   curl -I http://localhost:30080/ \
#     -H "Host: echo-precedence.localdev.me" \
#     -H "X-Version: v1"
#   # Should route to echo-server, X-Gateway-Matched-Route: echo/echo-precedence/rule0
#
#   # Rule 3: GET only (no headers/query)
#   curl -I http://localhost:30080/ \
#     -H "Host: echo-precedence.localdev.me"
#   # Should route to echo-server-v2, X-Gateway-Matched-Route: echo/echo-precedence/rule3
#
#   # Rule 1: POST (no matchers, different method)
#   curl -I -X POST http://localhost:30080/ \
#     -H "Host: echo-precedence.localdev.me"
#   # Should route to echo-server, X-Gateway-Matched-Route: echo/echo-precedence/rule1
#
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo-precedence
  namespace: echo
spec:
  parentRefs:
    - name: dev-gateway
  hostnames:
    - "echo-precedence.localdev.me"
  rules:
    # RULE 0: Medium precedence - GET + 1 header
    # Declared FIRST but should be sorted to position 2 (after rule 2)
    - matches:
        - path:
            type: PathPrefix
            value: /
          method: GET
          headers:
            - type: Exact
              name: X-Version
              value: v1
      backendRefs:
        - name: echo-server
          port: 80

    # RULE 1: Lowest precedence - No matchers (catch-all)
    # Declared SECOND but should be sorted to position 4 (last)
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: echo-server
          port: 80

    # RULE 2: Highest precedence - GET + 2 headers + 1 query param
    # Declared THIRD but should be sorted to position 1 (first)
    - matches:
        - path:
            type: PathPrefix
            value: /
          method: GET
          headers:
            - type: Exact
              name: X-Version
              value: v2
            - type: Exact
              name: X-Environment
              value: prod
          queryParams:
            - type: Exact
              name: debug
              value: "true"
      backendRefs:
        - name: echo-server-v2
          port: 80

    # RULE 3: Low precedence - GET only
    # Declared FOURTH but should be sorted to position 3 (before catch-all)
    - matches:
        - path:
            type: PathPrefix
            value: /
          method: GET
      backendRefs:
        - name: echo-server-v2
          port: 80

---
##############################################################################
# TLS TERMINATION - Gateway HTTPS listener with TLS Terminate mode
##############################################################################

# TLS Secret for Gateway HTTPS listener
---
apiVersion: v1
kind: Secret
metadata:
  name: gateway-tls-cert
  namespace: echo
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURIekNDQWdlZ0F3SUJBZ0lVR1AyWUpEVCttcGFjN21rNFdPb09EdXRsd3Vrd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0h6RWRNQnNHQTFVRUF3d1VaV05vYnkxMGJITXViRzlqWVd4a1pYWXViV1V3SGhjTk1qVXhNVEl3TVRBeQpPVEV3V2hjTk1qWXhNVEl3TVRBeU9URXdXakFmTVIwd0d3WURWUVFEREJSbFkyaHZMWFJzY3k1c2IyTmhiR1JsCmRpNXRaVENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFOdzB1NmZoUkFXeG5Ta0YKWk1ZWXArcmxMTmg3WFRuaVo4QVFMdGxpdHBpRW9ncWdZMmVVUjJQbUZIbHpjKzE5U2k3T0ZWcVBVakxUR0JvdwpMcDNRVjFPVjZoN2JoMzdybHg2ZzJMd1lBRnJ6d2JRK04xTnRMRUQ5OWswTWlQODhLM1pESkpLUE1jYVJSamE4CndHb0dQUWZCdlRMSjZ1STBadE82aUFDZUZlZEJVLytubXZQTVg5OVg1NlA5bmpsdkthaXFKVXNkWGZlOE1xS1QKRkNjb25IQ3IwZWVmMXE4SHJZTHo2QUZoZ2tUNnpYb1BNeWpJMFIvS2ljbzNoOUIvbGU4RDdvQ0xHM3gxN3QwcQpna0xqN0xOY1IxSW9YSGxaQzJkYlE4dEVzWXFMd3hlaFhWZ0lVRmZtSjVSMm1tcU1sdmJ5U2dWdzRPYUErd0VQCmhucngvdkVDQXdFQUFhTlRNRkV3SFFZRFZSME9CQllFRkpMRjFmclZMMVp2akR5NWVqeWV1aUo0aEkrcU1COEcKQTFVZEl3UVlNQmFBRkpMRjFmclZMMVp2akR5NWVqeWV1aUo0aEkrcU1BOEdBMVVkRXdFQi93UUZNQU1CQWY4dwpEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRDZPTVEvUDVJQ1puSlM2MXRhcmJab2NjMFhIMHp1alM4bUNtaXIrCkdDdVZtQThYVkl3Rnd0b2FBbU9XTkpGVlE2SnZXTnZIR25rTjZaWTVFcEtVeUZ1aSszdFpjQjNkTW9oZUZoUUIKMzE3NmZyNjBIVTBBeXdPVGJud3lRVWZtTm9KQ1NOb3A0NjZzNm1VNkI5TVRRWkMwYXZNcHlwcFFrN1lDb0gyUAprRVAwRmtJQklmUTIrVWozdzkvYkxjZHNXNVdJT3BnM3JFRGxPR1lmbDFhWVNrcjlqbkh2L2RlYXdMaUlvYzRsCnoxTkNlcWd1WmV0R2luTjFKNjZGZ2tjcjE2RHBKQnlKZ1grRlhtd2dxWEFHRUE0b2RiWXllZEtkRE9ORG9BZ1kKQkpGeEhJMjZ3QVk1OXNkNWVZYkFZd1F2alA5TUptR21SVmFmcFJ5ZmRHY0h3SFE9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRRGNOTHVuNFVRRnNaMHAKQldUR0dLZnE1U3pZZTEwNTRtZkFFQzdaWXJhWWhLSUtvR05ubEVkajVoUjVjM1B0ZlVvdXpoVmFqMUl5MHhnYQpNQzZkMEZkVGxlb2UyNGQrNjVjZW9OaThHQUJhODhHMFBqZFRiU3hBL2ZaTkRJai9QQ3QyUXlTU2p6SEdrVVkyCnZNQnFCajBId2IweXllcmlOR2JUdW9nQW5oWG5RVlAvcDVyenpGL2ZWK2VqL1o0NWJ5bW9xaVZMSFYzM3ZES2kKa3hRbktKeHdxOUhubjlhdkI2MkM4K2dCWVlKRStzMTZEek1veU5FZnlvbktONGZRZjVYdkErNkFpeHQ4ZGU3ZApLb0pDNCt5elhFZFNLRng1V1F0blcwUExSTEdLaThNWG9WMVlDRkJYNWllVWRwcHFqSmIyOGtvRmNPRG1nUHNCCkQ0WjY4Zjd4QWdNQkFBRUNnZ0VBRVczbUZZTmR1aktrL1JoMWNiMkZXdkVCUS9BOXdJVmtUMTRvaXlIR1VKdWMKNU1qdG5VYnVBS0QzS1diRE8vNnc5clB1bWtDaVVhNEdLQnA4c2hhSnR1NjBmWFZFUy80ek02UXBDM2c5M1BVUwp0YVRBQmMwc0ZjZlVMU1NMR21LbGtRSisvRSt6c2FNUmd1Y2ROcmNnTVFNN2FhLzBOS3ZQb0w0UW9qWGhCM0R0CmJvYVFZRXFiNUUzT3JPbXFtSnJJb3h5aFNOOGxhWS9lMW5OR2diMXV6eVFkVUxid0NRSkovd1VmOE45OW9xZFUKR3JvQTluR3NSSW50QVpJL0xnL0tYOG9hVmZaNDMwR3pjOHJwTmt6T1NNdmx6TVhFQkkwZWZpY1hSUFhpYkpPbwpaYzF5TXErMW15MDlEdmV1N2ZwWjRaU3VsbkxVNnZTUndiNzF4OXhlVVFLQmdRRDBUT1Z4MHZNNGxKeTYwY2pYClU2ZUZNMkFNLzZsa1YvTGdOUjFHR1U4aG9OemlIRGMrcnBSVHpBbmtMcFU5VTdnaitsd3VRT3Raby9nQ01kMWkKQU9vZy9uR0lKM1p2QlNjbTZWSUhFbWkycTFGMXZDeVZnRHl3Y09YNituYmJ4cGN1VXVCUXJDUTN6VjliQ0xDZQp0UmVVS05KTTFwemtobVlWT0NxeVZTMGNtUUtCZ1FEbXdIRUJxcGI5QnNPUTN2aXRxbHFabmtaMTEwaEk1Y1AvCk40elVZZmo5Q1B4MEdrOUFhdFpHbk1ucDNWQXZxaWlhbmRYbXlwZkNYVk5scy9PMHFCMitzU2Z0ODNtVTRIOVkKWVh6Q3ZUSFZTTmd3L0o2ZnI0NjUwLzUvb1c1YmZHcDcyUTdIVFEzRmRvalBraW95ZE9kSGxJcG9aS21aYVRMaQphY3RzYm1oVUdRS0JnQmNHbkdXakRWdWEzajdaZ1FXU2srcUJFaCtIaFU2NDMySjBmeUxaUmRVVWxWMFdiYnFSCnQ5ZENGdmlUejJzdFZlREdPeVA4NkhIVmU0MnhaMzFTT3I4TFhHWUoyaWJTcElNTllMYmI3RlN6UndWQ3pDejMKSGtFL0V0NFo5MVAxbnRBMTdZQ05DUWpkYVl4cUFFT2xLK2pDQkRoTHpoUFgrdzBxOHhORjVlK1pBb0dBV3d0ZgpDeXRGdTd2cGVjV2dGTlY4UGRSbk5LT21qNnlvY3BCMmJtM2hrZVR6eHRPQ3BZWUIyWWFQWEVqSUZLWnNzdVRICnV2SUFndDNUdy9NR215Y2g1VlY4emJRZEtwS1JiRXU2c0JONkVBOVh6YXcrNGY2Z3I4MW5RdkJzM0lmd2M4RW0KeFpndmNOUGVFeGcyc2dYU0l6b0dpajM5ZE53L0NYcDRtdVhOSURFQ2dZQUdpYm1nRmp5SkQwYnNsY0RIVDVoSQpSUTU5ZXZjQWV5cVAvSmc1UkVlNWVNOXFKclY5ZVdoMXpwRjZlU0pqNUlQMnp2OTBtQm5QRi9RWmMvM2QzMDBGCkFxNVVTS2pGWS9kUDJoblNsT1BnNGRqVmM0dkV5WWxxNUN4cUdWbHVXbmJ4YjFSMGpGeVRhSDEwNkpxRWtScnkKam82TGFZKzRRWHhlblcwSGtRc0F5dz09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K

# Gateway with HTTPS listener using TLS Terminate mode
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: tls-gateway
  namespace: echo
spec:
  gatewayClassName: haproxy
  listeners:
    - name: https
      protocol: HTTPS
      port: 443
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            name: gateway-tls-cert

---
# HTTPRoute 9: TLS Termination via Gateway HTTPS listener
# Demonstrates: Gateway API TLS Terminate mode with HTTPS listener
# Test with: curl -k https://echo-gateway-tls.localdev.me/
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo-gateway-tls
  namespace: echo
spec:
  parentRefs:
    - name: tls-gateway
      sectionName: https
  hostnames:
    - "echo-gateway-tls.localdev.me"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: echo-server
          port: 80
