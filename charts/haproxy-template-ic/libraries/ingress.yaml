# Ingress template library for HAProxy Template Ingress Controller
# Provides support for Kubernetes networking.k8s.io/v1 Ingress resources
# Implements the resource_ingress_* plugin interface for the base library

watchedResources:
  ingresses:
    apiVersion: networking.k8s.io/v1
    resources: ingresses
    indexBy: ["metadata.namespace", "metadata.name"]
    enableValidationWebhook: true
    # Filter by ingress class name (only watches ingresses with matching spec.ingressClassName)
    # Set to empty string ("") to watch all ingresses regardless of class
    fieldSelector: "spec.ingressClassName=haproxy"
  services:
    apiVersion: v1
    resources: services
    indexBy: ["metadata.namespace", "metadata.name"]
  endpoints:
    apiVersion: discovery.k8s.io/v1
    resources: endpointslices
    indexBy: ["metadata.namespace", "metadata.labels.kubernetes\\.io/service-name"]

templateSnippets:
  # Register Ingress TLS certificates with SSL infrastructure
  # This snippet runs early (priority 100) to register TLS secrets before SSL config generation
  features-ingress-tls:
    priority: 100
    template: |
      {#- Register TLS certificates from Ingress spec.tls with SSL infrastructure #}
      {#- Each TLS entry contains hosts (SNI patterns) and a secretName #}
      {#- Dynamically generates certificate files using file_registry.Register() #}
      {#- Deduplication: Only register each secret once even if multiple Ingresses use it #}
      {%- set ns = namespace(registered_secrets=[]) %}
      {%- for ingress in resources.ingresses.List() %}
        {%- if ingress.spec and ingress.spec.tls %}
          {%- for tls in ingress.spec.tls %}
            {%- if tls.secretName %}
              {#- Unique key for this secret (namespace + name) #}
              {%- set secret_key = ingress.metadata.namespace ~ "/" ~ tls.secretName %}
              {%- if secret_key not in ns.registered_secrets %}
                {%- set ns.registered_secrets = ns.registered_secrets.append(secret_key) %}

                {#- Fetch Secret and extract cert+key #}
                {%- set secret = resources.secrets.GetSingle(ingress.metadata.namespace, tls.secretName) %}
                {%- if secret and secret.data and secret.data["tls.crt"] and secret.data["tls.key"] %}
                  {#- Combine cert and key into single PEM (HAProxy format) #}
                  {%- set combined_pem = secret.data["tls.crt"] | b64decode ~ "\n" ~ secret.data["tls.key"] | b64decode %}

                  {#- Register certificate file dynamically using file_registry #}
                  {%- set cert_filename = ingress.metadata.namespace ~ "_" ~ tls.secretName ~ ".pem" %}
                  {%- set _ = file_registry.Register("cert", cert_filename, combined_pem) %}

                  {#- Register with SSL infrastructure for crt-list generation #}
                  {%- set tls_cert = {
                    "secret_namespace": ingress.metadata.namespace,
                    "secret_name": tls.secretName,
                    "sni_patterns": tls.hosts | default([])
                  } %}
                  {%- set global_features.tls_certificates = global_features.tls_certificates.append(tls_cert) %}
                {%- endif %}
              {%- endif %}
            {%- endif %}
          {%- endfor %}
        {%- endif %}
      {%- endfor %}

  util-backend-name-ingress:
    template: >-
      {{- "" -}}ing_{{ ingress.metadata.namespace }}_{{ ingress.metadata.name }}_{{ path.backend.service.name }}_{{ path.backend.service.port.name | default(path.backend.service.port.number) }}

  util-path-map-entry-ingress:
    template: |
      {#- Generate map entries for paths matching specified pathTypes #}
      {#- Usage: {% include "util-path-map-entry-ingress" with context %} where path_types = ["Exact"] or ["Prefix", "ImplementationSpecific"] #}
      {%- for ingress in resources.ingresses.List() %}
      {#- Count matching paths for this ingress -#}
      {%- set ns_paths = namespace(all_paths=[]) %}
      {%- for rule in (ingress.spec.rules | default([]) | selectattr("http", "defined")) %}
      {%- for path in (rule.http.paths | default([]) | selectattr("path", "defined")) %}
      {%- for check_type in path_types %}
      {%- if path.pathType == check_type %}
      {%- set ns_paths.all_paths = ns_paths.all_paths.append(path) %}
      {%- endif %}
      {%- endfor %}
      {% endfor %}
      {% endfor %}
      {%- if ns_paths.all_paths | length > 0 %}
      # Ingress: {{ ingress.metadata.namespace }}/{{ ingress.metadata.name }} ({{ ns_paths.all_paths | length }} paths)
      {%- for rule in (ingress.spec.rules | default([]) | selectattr("http", "defined")) %}
      {%- for path in (rule.http.paths | default([]) | selectattr("path", "defined")) %}
      {%- for check_type in path_types %}
      {%- if path.pathType == check_type %}
      #   - {{ rule.host }}{{ path.path }} → {{ path.backend.service.name }}:{{ path.backend.service.port.number | default(path.backend.service.port.name) }}
      {%- endif %}
      {%- endfor %}
      {% endfor %}
      {% endfor %}
      {% for rule in (ingress.spec.rules | default([]) | selectattr("http", "defined")) %}
      {%- for path in (rule.http.paths | default([]) | selectattr("path", "defined")) %}
      {%- for check_type in path_types %}
      {%- if path.pathType == check_type %}
      {{ "\n" }}{{ rule.host }}{{ path.path }} BACKEND:{% include "util-backend-name-ingress" -%}{{ suffix }}
      {%- endif %}
      {%- endfor %}
      {% endfor %}
      {% endfor %}
      {%- endif %}
      {%- endfor %}

  backends-ingress:
    template: |
      {#- Generate all backend definitions from ingress resources #}
      {#- Implements backends-* extension point from base library #}
      {#- Deduplicate backends: multiple paths to same service+port share one backend #}
      {%- set ns = namespace(seen=[]) %}
      {%- for ingress in resources.ingresses.List() -%}
      {%- if loop.first %}
      # ingress/backends-ingress

      {% endif -%}
      {%- if ingress.spec and ingress.spec.rules %}
      {%- for rule in ingress.spec.rules -%}
      {%- if rule.http and rule.http.paths %}
      {%- for path in rule.http.paths -%}
      {%- if path.backend and path.backend.service %}
      {%- set service_name = path.backend.service.name -%}
      {%- set port = path.backend.service.port.number | default(80) -%}
      {#- Compute backend key for deduplication (matches util-backend-name-ingress) #}
      {%- set backend_key = ingress.metadata.namespace ~ "_" ~ ingress.metadata.name ~ "_" ~ path.backend.service.name ~ "_" ~ (path.backend.service.port.name | default(path.backend.service.port.number)) -%}
      {%- if backend_key not in ns.seen -%}
      {%- set ns.seen = ns.seen.append(backend_key) %}
      # Backend for: Ingress {{ ingress.metadata.namespace }}/{{ ingress.metadata.name }} → Service {{ service_name }}:{{ port }}
      backend {%+ include "util-backend-name-ingress" +%}
        balance roundrobin
        option httpchk GET {{ path.path | default('/') }}
        default-server check
        {%- filter indent(2, first=True) %}
        {#- Initialize server options namespace before backend-directives can append to it #}
        {%- set ns_server_opts = namespace(flags=[]) %}
        {% include "backend-directives" -%}
        {#- Backend config snippet injection (Ingress-only) #}
        {%- set backend_snippet = ingress.metadata.annotations["haproxy.org/backend-config-snippet"] | default("") %}
        {%- if backend_snippet %}
        # haproxytech/backend-config-snippet
        {{ backend_snippet | indent(2, first=False) }}
        {%- endif -%}
        {% include "util-backend-servers" %}
        {%- endfilter -%}
      {%- endif -%}
      {%- endif -%}
      {%- endfor -%}
      {%- endif -%}
      {%- endfor -%}
      {%- endif -%}
      {%- endfor -%}
  map-host-ingress:
    template: |
      {#- Generate host map entries for Ingress resources #}
      {#- Implements map-host-* extension point from base library #}
      {%- for ingress in resources.ingresses.List() -%}
      {%- if loop.first %}
      # ingress/map-host-ingress
      {%- endif %}
      {%- set rules_with_http = ingress.spec.rules | default([]) | selectattr("http", "defined") | list %}
      {%- if rules_with_http | length > 0 %}
      # Ingress: {{ ingress.metadata.namespace }}/{{ ingress.metadata.name }} ({{ rules_with_http | length }} hosts)
      {% for rule in rules_with_http %}
      {%- set host_without_asterisk = rule.host | replace('*', '', 1) %}
      {{ host_without_asterisk }} {{ host_without_asterisk }}
      {% endfor %}
      {%- endif %}
      {%- endfor %}

  map-path-exact-ingress:
    template: |
      {#- Generate exact path map entries for Ingress resources #}
      {#- Implements map-path-exact-* extension point from base library #}
      # ingress/map-path-exact-ingress
      {% set path_types = ["Exact"] %}
      {%- set suffix = "" %}
      {% include "util-path-map-entry-ingress" %}

  map-path-prefix-exact-ingress:
    template: |
      {#- Generate prefix-exact path map entries for Ingress resources #}
      {#- Implements map-path-prefix-exact-* extension point from base library #}
      # ingress/map-path-prefix-exact-ingress
      {% set path_types = ["Prefix", "ImplementationSpecific"] %}
      {%- set suffix = "" %}
      {% include "util-path-map-entry-ingress" %}

  map-path-prefix-ingress:
    template: |
      {#- Generate prefix path map entries with trailing slash for Ingress resources #}
      {#- Implements map-path-prefix-* extension point from base library #}
      # ingress/map-path-prefix-ingress
      {% set path_types = ["Prefix", "ImplementationSpecific"] %}
      {%- set suffix = "/" %}
      {% include "util-path-map-entry-ingress" %}

validationTests:
  test-ingress-duplicate-backend-different-ports:
    description: Ingress with multiple paths to same service but different ports (tests deduplication)
    fixtures:
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            name: api-svc
            namespace: default
          spec:
            ports:
              - name: http
                port: 80
                targetPort: 8080
              - name: admin
                port: 81
                targetPort: 8081
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: api-svc-abc123
            namespace: default
            labels:
              kubernetes.io/service-name: api-svc
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.0.1"
              targetRef:
                kind: Pod
                name: api-pod-1
          ports:
            - name: http
              port: 8080
              protocol: TCP
            - name: admin
              port: 8081
              protocol: TCP
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: multi-port
            namespace: default
          spec:
            ingressClassName: haproxy
            rules:
              - host: example.com
                http:
                  paths:
                    - path: /api
                      pathType: Prefix
                      backend:
                        service:
                          name: api-svc
                          port:
                            number: 80
                    - path: /admin
                      pathType: Prefix
                      backend:
                        service:
                          name: api-svc
                          port:
                            number: 81
                    - path: /app
                      pathType: Prefix
                      backend:
                        service:
                          name: api-svc
                          port:
                            number: 80
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "backend ing_default_multi-port_api-svc_80"
        description: Must generate backend for port 80

      - type: contains
        target: haproxy.cfg
        pattern: "backend ing_default_multi-port_api-svc_81"
        description: Must generate backend for port 81

      - type: match_count
        target: haproxy.cfg
        pattern: "backend ing_default_multi-port_api-svc_"
        expected: "2"
        description: Must generate exactly 2 backends (deduplication test)

      - type: contains
        target: map:path-prefix.map
        pattern: "example.com/api BACKEND:ing_default_multi-port_api-svc_80/"
        description: Path prefix map must use BACKEND qualifier for /api

      - type: contains
        target: map:path-prefix.map
        pattern: "example.com/admin BACKEND:ing_default_multi-port_api-svc_81/"
        description: Path prefix map must use BACKEND qualifier for /admin

      - type: contains
        target: map:path-prefix.map
        pattern: "example.com/app BACKEND:ing_default_multi-port_api-svc_80/"
        description: Path prefix map must use BACKEND qualifier for /app

      - type: contains
        target: map:path-prefix-exact.map
        pattern: "example.com/api BACKEND:ing_default_multi-port_api-svc_80"
        description: Path prefix-exact map must use BACKEND qualifier for /api

      - type: contains
        target: map:path-prefix-exact.map
        pattern: "example.com/admin BACKEND:ing_default_multi-port_api-svc_81"
        description: Path prefix-exact map must use BACKEND qualifier for /admin

      - type: contains
        target: map:path-prefix-exact.map
        pattern: "example.com/app BACKEND:ing_default_multi-port_api-svc_80"
        description: Path prefix-exact map must use BACKEND qualifier for /app

      # Map Formatting Tests - Ensure proper line separation
      - type: not_contains
        target: map:host.map
        pattern: "hosts\\)\\S"
        description: Host map comments must not concatenate with entries (no non-whitespace immediately after comment)

      - type: not_contains
        target: map:path-prefix.map
        pattern: "paths\\)\\S"
        description: Path prefix map comments must not concatenate with entries

      - type: not_contains
        target: map:path-prefix-exact.map
        pattern: "paths\\)\\S"
        description: Path prefix-exact map comments must not concatenate with entries

      - type: contains
        target: map:host.map
        pattern: "(?m)^example\\.com example\\.com$"
        description: Host map entries must start at beginning of line and be properly formatted

      - type: contains
        target: map:path-prefix.map
        pattern: "(?m)^example\\.com/api BACKEND:"
        description: Path prefix map entries must start at beginning of line

      - type: contains
        target: map:path-prefix-exact.map
        pattern: "(?m)^example\\.com/api BACKEND:"
        description: Path prefix-exact map entries must start at beginning of line

  test-ingress-tls-basic:
    description: Ingress with spec.tls should register TLS certificates
    fixtures:
      secrets:
        - apiVersion: v1
          kind: Secret
          type: kubernetes.io/tls
          metadata:
            name: example-tls
            namespace: default
          data:
            # Test certificate (base64-encoded)
            tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURDekNDQWZPZ0F3SUJBZ0lVT2FGRWhyWlRXZ1JpbEorSFJCOWhJQnlzT2xNd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0ZERVNNQkFHQTFVRUF3d0piRzlqWVd4b2IzTjBNQ0FYRFRJMU1URXhPVEU0TWpVMU1Wb1lEekl4TWpVeApNREkyTVRneU5UVXhXakFVTVJJd0VBWURWUVFEREFsc2IyTmhiR2h2YzNRd2dnRWlNQTBHQ1NxR1NJYjNEUUVCCkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDWDJIQnA0V00rbFIvSXljLzRMR01qUHk0bUdFcUtVYm5xaFdRbU9nMXgKNHlnRkkzMkcyNWZYR1djZ0ZtVmg4YkZSZVFxdTB0Z1k2SUo5UE9nWmd5eHNhaUgzeldBMi8wbkdEejVvN2dYeQp5Z0VLaTdZY3M3bHNFNng0Y3lLK2tZaFdvZkNNaDJDck5LNWVCVzlRUnh3U3pieDNWREZqVS9HdVVaQnRBVWxICkRLd2ZCb0ZHNEhzaEZDUHl2Y3BuTlNLbUdwS0wwZ0UyczNBTHN5NWpqYjRpMnpyQng4Mng0Y3hQZUlCOEt6ckMKMDZvQXVwbzJDdUxaQTFMMkMrZVB5UlQ0QWxRUGNOL2l3WmdqMyt3eG8vWkFJaUxQK2NXbUY1dUdXeTZUREoybAo2K2FLYWFOajFCVVBWSkxTdW92WFhCMmc2akYxdWxIM1VWNVhPMlVMQ1ZzUkFnTUJBQUdqVXpCUk1CMEdBMVVkCkRnUVdCQlRHdi9VWG5nZ2tKaytpTkN0WnFwMStTSS9JaGpBZkJnTlZIU01FR0RBV2dCVEd2L1VYbmdna0prK2kKTkN0WnFwMStTSS9JaGpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBSwozb3QyQTRyR05DWEpuZHB5OWlBa0dUUnk2SWxCcExKUlNJZ1JOWmlZQkU4SEtlWnUyR3JnUGI3V0ZUL1RyWkI2Cm5jMjhzVjdsYUNDNXlyZVUxeGVpL2ZjTllPSHlscWdBR2lFYmt2Um1za1hTd24wSlFaanpUNWl1a2hObVBkV0QKSWx0bWhCU3FsZlRsWFRYaytjMVlzeUJrVkN5TVNOdUZMd3pkODlLanJlU2xsZzE5clRVUmlLRzZGU0o2azBPSQprVE1lbWczRGZabldZSytNZnBxdjlVSDJSblBhMVJlbHJ4aTNLTWZoV0h2b2wxeUlVSGdnT0g3MkE4Wkd6eFZMClh4L09rSS8weXozUFhvM0xtUkRqczMzWUpXSzRTMmRwaFpyS3RMS2hqcEFIZzI1Nk8zUlN1bWd2d2NpYzZVRWMKaEpvWitneWZacUdBcnJ6M1dWTTkKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
            tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV1d0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktVd2dnU2hBZ0VBQW9JQkFRQ1gySEJwNFdNK2xSL0kKeWMvNExHTWpQeTRtR0VxS1VibnFoV1FtT2cxeDR5Z0ZJMzJHMjVmWEdXY2dGbVZoOGJGUmVRcXUwdGdZNklKOQpQT2daZ3l4c2FpSDN6V0EyLzBuR0R6NW83Z1h5eWdFS2k3WWNzN2xzRTZ4NGN5SytrWWhXb2ZDTWgyQ3JOSzVlCkJXOVFSeHdTemJ4M1ZERmpVL0d1VVpCdEFVbEhES3dmQm9GRzRIc2hGQ1B5dmNwbk5TS21HcEtMMGdFMnMzQUwKc3k1ampiNGkyenJCeDgyeDRjeFBlSUI4S3pyQzA2b0F1cG8yQ3VMWkExTDJDK2VQeVJUNEFsUVBjTi9pd1pnagozK3d4by9aQUlpTFArY1dtRjV1R1d5NlRESjJsNithS2FhTmoxQlVQVkpMU3VvdlhYQjJnNmpGMXVsSDNVVjVYCk8yVUxDVnNSQWdNQkFBRUNnZjhKSHBhaHhVZVFtcVF1Q3ZEU2x0ZmRaZzMvZTdYK1dLb3h5NUVZT3FSVUVyQjAKbm8wTGJHVFNKbFJyT08wZDFNWXhmbk9GekdQdUd3aTdQTTB6dXcwUDljL1VjaUUxTEYvaDVVaDZSTkZXbzRzcwpkdmVaQWJKQksyMVFUcG5ubUJYNEhnRzBidXovVzBxZG12WDBmRkRUVUVmaFlzMFVpaFlad2d4S2Y2bEcrd1FzClZRclNiTzlMKzRJaHN2cnNSQlRGYU1nV0FMNGp0a3VpcTdSaVFkamRpejRkMmZJd1FtcVR5VEFvWlh5ZW9WRmEKM2JlRXh3aWtJME5pcXBNTWlaUjlXeTYzZkw2TlowZ0F5T0dKL09FaVU2Q3kyV2JCQzZrbVhnRlpOVW1Va1B5dAp3TXlqNTg5ZG1taDNaTGw1VEloNzVOc1dTNlVvTm1abzV3MmxLWUVDZ1lFQXh5N3dJeWxFbDlLaURvT1Q5V3gyCjFOcnp3bjQzLzVVbFAxakVFM0NiMXBiRDJCQjRUNXM4TmxCSEFOa0tFeFI1RUJnNTNYakw3aVlvTU1rWWUwL1YKRFVOdWFLRzlaaHhUSklualdPNURNUDE2NVFwNlBzdklObmlVZ1JLcW1Bc1hSNkNkN0NXeVIzcEZVOUZPcEJpWgo2aWt1eFVNYnZFWW8xVHNUWjB2Umw5RUNnWUVBd3lpNVNORWpEM2x6UHozcm5OVllRTEJBL2V1NS8wS1JXc2hQCmJVcit0YUszN1l4ZEJMV1JHOVpjOHd2ZU9pVWZTUHhWNmwyWnFRdVQ0VVVFdmYrbTlJWEZGZXZxUE1IanNZUVQKVVlRQVRxMkgwelF3Mm5kS2thdDlWSk81UVZKV252N0YxaWY5S3VPRFozbEhiUk96aEJjZjZXUWlBS0RNQWQ3cwpQNDNYbjBFQ2dZRUFxNmFacjlONmwxUWY4RjRYL2lLdzdaS2JDdnQzQ3J6ZlVvNE91Nm9Kd280K3pFNjFQL1ZKCm1JenFBNk1HK1pabEZpZXFobC81Ym94WGltTml3N0h5cXZGM2pwZ0QvcUZlVFZpL0lmNkN6UTlFLzJsZUhBdkYKeUp0MWJ4NUZBYTVkSzQ4UlNWYmJJcG9PY01NcUFHUnJEODdaelltZHQwekhGNnRIZDNkeGNtRUNnWUFzRWJNZApWVlNVZHZsbVM0WTc2UlUvcmsxT3lYODd1LzEwd1l6bUFpeFlPY0ZNM0FoWk91TGtwVmhoN2NrbDJpSWhhaEhBCmxaaFFTdlAreDRZVm5YaEcrVG9UQkMzbHdHYTVQRGpjakhGQlV3QTcyaW81K3Z3VXZ1UFRTSFJwNHJ6NnRFOWEKVjdkY2l2bXVVUDJuRE83Wm9oc3JxZGZmeW0rbThIN3FydzRFd1FLQmdEV1RqME82TXpyUUVhQVlrUVVucERVLwpYOFd5OGlPcStFYU5ZejNWWUtKSm5xVkJTeldLZDIrRFRQVmlvVHZqOVhVYkhGK1p3MW9ieXljcklDcVgrd0RCCkl4ZXBoMlBNNERKUHVlRnFJVzRqY3lQSkJuVGt4OVBuNUNKem1XSUJybE1vZjZON2tvWFIzMFBMbjlDRlRpNFoKa1dhTnhjR3BROVNldjVQeEoxL2QKLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo=
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            name: web-svc
            namespace: default
          spec:
            ports:
              - port: 80
                targetPort: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: web-svc-abc
            namespace: default
            labels:
              kubernetes.io/service-name: web-svc
          addressType: IPv4
          endpoints:
            - addresses: ["10.0.0.1"]
          ports:
            - port: 8080
              protocol: TCP
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: tls-ingress
            namespace: default
          spec:
            ingressClassName: haproxy
            tls:
              - hosts:
                  - example.com
                  - www.example.com
                secretName: example-tls
            rules:
              - host: example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: web-svc
                          port:
                            number: 80
    assertions:
      - type: haproxy_valid
        description: HAProxy config must be valid with Ingress TLS

      - type: contains
        target: crt-list:certificate-list.txt
        pattern: "default_example-tls\\.pem \\[ocsp-update on\\] example\\.com www\\.example\\.com"
        description: CRT-list must include Ingress TLS certificate with SNI patterns

      - type: contains
        target: cert:default_example-tls.pem
        pattern: "BEGIN CERTIFICATE"
        description: TLS certificate file must be generated from Secret
