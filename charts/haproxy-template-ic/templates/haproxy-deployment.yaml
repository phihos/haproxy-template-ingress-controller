{{- if .Values.haproxy.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "haproxy-template-ic.fullname" . }}-haproxy
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "haproxy-template-ic.labels" . | nindent 4 }}
    app.kubernetes.io/component: loadbalancer
spec:
  replicas: {{ .Values.haproxy.replicaCount }}
  selector:
    matchLabels:
      {{- include "haproxy-template-ic.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: loadbalancer
  template:
    metadata:
      labels:
        {{- include "haproxy-template-ic.selectorLabels" . | nindent 8 }}
        {{- include "haproxy-template-ic.componentLabels" "loadbalancer" | nindent 8 }}
    spec:
      {{- with .Values.haproxy.priorityClassName }}
      priorityClassName: {{ . }}
      {{- end }}
      {{- with .Values.haproxy.topologySpreadConstraints }}
      topologySpreadConstraints:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: {{ include "haproxy-template-ic.haproxy.runAsUser" . }}
        runAsGroup: {{ include "haproxy-template-ic.haproxy.runAsGroup" . }}
        fsGroup: {{ include "haproxy-template-ic.haproxy.fsGroup" . }}
        {{- with .Values.haproxy.podSecurityContext.seccompProfile }}
        seccompProfile:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      containers:
        # HAProxy container
        - name: haproxy
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
              {{- if .Values.haproxy.enterprise.enabled }}
              # Enterprise binaries have file capabilities requiring NET_BIND_SERVICE
              # PSS Restricted profile allows this capability
              add: [NET_BIND_SERVICE]
              {{- end }}
            runAsNonRoot: true
            runAsUser: {{ include "haproxy-template-ic.haproxy.runAsUser" . }}
          image: {{ include "haproxy-template-ic.haproxy.image" . }}
          imagePullPolicy: {{ .Values.haproxy.image.pullPolicy }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              # Create required directories
              mkdir -p /etc/haproxy/maps /etc/haproxy/certs /etc/haproxy/errors /etc/haproxy/general
              # Use UIDs for chown (user/group names differ between Community and Enterprise)
              chown -R {{ include "haproxy-template-ic.haproxy.runAsUser" . }}:{{ include "haproxy-template-ic.haproxy.runAsGroup" . }} /etc/haproxy || true

              # Copy initial config
              cp /config/haproxy.cfg /etc/haproxy/haproxy.cfg

              # Start HAProxy in master-worker mode with master socket
              exec {{ include "haproxy-template-ic.haproxy.bin" . }} -W -db -S "/etc/haproxy/haproxy-master.sock,level,admin" -- /etc/haproxy/haproxy.cfg
          ports:
            - name: http
              containerPort: {{ .Values.haproxy.ports.http }}
              protocol: TCP
            - name: https
              containerPort: {{ .Values.haproxy.ports.https }}
              protocol: TCP
            - name: stats
              containerPort: {{ .Values.haproxy.ports.stats }}
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /config
            - name: haproxy-runtime
              mountPath: /etc/haproxy
          livenessProbe:
            httpGet:
              path: /healthz
              port: stats
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: stats
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            {{- toYaml .Values.haproxy.resources | nindent 12 }}

        # Dataplane API sidecar
        - name: dataplane
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
              {{- if .Values.haproxy.enterprise.enabled }}
              # Enterprise: dataplaneapi calls HAProxy binary which has file capabilities
              # PSS Restricted profile allows this capability
              add: [NET_BIND_SERVICE]
              {{- end }}
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: {{ include "haproxy-template-ic.haproxy.dataplaneRunAsUser" . }}
          image: {{ include "haproxy-template-ic.haproxy.image" . }}
          imagePullPolicy: {{ .Values.haproxy.image.pullPolicy }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              # Wait for HAProxy to create the socket
              while [ ! -S /etc/haproxy/haproxy-master.sock ]; do
                echo "Waiting for HAProxy master socket..."
                sleep 1
              done

              # Create required directories
              # Note: Directories owned by user 99 via pod fsGroup, no chown needed
              mkdir -p /var/lib/dataplaneapi/transactions /var/lib/dataplaneapi/backups
              mkdir -p /etc/haproxy/maps /etc/haproxy/certs /etc/haproxy/general

              # Create Dataplane API config
              cat > /etc/haproxy/dataplaneapi.yaml <<'EOF'
              config_version: 2
              name: haproxy-dataplaneapi
              dataplaneapi:
                host: 0.0.0.0
                port: {{ .Values.haproxy.ports.dataplane }}
                user:
                  - name: {{ .Values.haproxy.dataplane.credentials.username }}
                    password: {{ .Values.haproxy.dataplane.credentials.password }}
                    insecure: true
                transaction:
                  transaction_dir: /var/lib/dataplaneapi/transactions
                  backups_number: 10
                  backups_dir: /var/lib/dataplaneapi/backups
                resources:
                  maps_dir: /etc/haproxy/maps
                  ssl_certs_dir: /etc/haproxy/certs
                  general_storage_dir: /etc/haproxy/general
              haproxy:
                config_file: /etc/haproxy/haproxy.cfg
                haproxy_bin: {{ include "haproxy-template-ic.haproxy.bin" . }}
                master_worker_mode: true
                master_runtime: /etc/haproxy/haproxy-master.sock
                reload:
                  reload_delay: 1
                  reload_cmd: /bin/sh -c "echo 'reload' | socat stdio unix-connect:/etc/haproxy/haproxy-master.sock"
                  restart_cmd: /bin/sh -c "echo 'reload' | socat stdio unix-connect:/etc/haproxy/haproxy-master.sock"
                  reload_strategy: custom
              log_targets:
                - log_to: stdout
                  log_level: trace
                  log_types:
                  - access
                  - app
              EOF

              # Start Dataplane API
              exec {{ include "haproxy-template-ic.haproxy.dataplanebin" . }} -f /etc/haproxy/dataplaneapi.yaml
          ports:
            - name: dataplane
              containerPort: {{ .Values.haproxy.ports.dataplane }}
              protocol: TCP
          volumeMounts:
            - name: haproxy-runtime
              mountPath: /etc/haproxy
            - name: dataplane-data
              mountPath: /var/lib/dataplaneapi
            - name: dataplane-tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /v3/info
              port: dataplane
              httpHeaders:
                - name: Authorization
                  value: "Basic {{ printf "%s:%s" .Values.haproxy.dataplane.credentials.username .Values.haproxy.dataplane.credentials.password | b64enc }}"
            initialDelaySeconds: 15
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /v3/info
              port: dataplane
              httpHeaders:
                - name: Authorization
                  value: "Basic {{ printf "%s:%s" .Values.haproxy.dataplane.credentials.username .Values.haproxy.dataplane.credentials.password | b64enc }}"
            initialDelaySeconds: 10
            periodSeconds: 5

      volumes:
        - name: config
          configMap:
            name: {{ include "haproxy-template-ic.fullname" . }}-haproxy-config
        - name: haproxy-runtime
          emptyDir: {}
        - name: dataplane-data
          emptyDir: {}
        - name: dataplane-tmp
          emptyDir: {}
{{- end }}
