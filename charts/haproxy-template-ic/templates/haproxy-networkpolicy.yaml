{{- if and .Values.haproxy.enabled .Values.haproxy.networkPolicy.enabled }}
{{- /*
  Validate configuration to prevent deny-all scenarios
*/ -}}
{{- if and (not .Values.haproxy.networkPolicy.allowExternal) (not .Values.haproxy.networkPolicy.allowedSources) }}
  {{- fail "haproxy.networkPolicy.allowExternal is false but haproxy.networkPolicy.allowedSources is empty. This would create a deny-all policy. Either set allowExternal: true or provide allowedSources." }}
{{- end }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "haproxy-template-ic.fullname" . }}-haproxy
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "haproxy-template-ic.labels" . | nindent 4 }}
    app.kubernetes.io/component: loadbalancer
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: loadbalancer
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/name: {{ include "haproxy-template-ic.name" . }}

  policyTypes:
    - Ingress
    - Egress

  # Ingress rules - what can access HAProxy
  ingress:
    # Allow traffic on HTTP/HTTPS ports
    - ports:
        - port: {{ .Values.haproxy.ports.http }}
          protocol: TCP
        - port: {{ .Values.haproxy.ports.https }}
          protocol: TCP
      {{- if not .Values.haproxy.networkPolicy.allowExternal }}
      # Restrictive mode - only allow from specific sources
      from:
        {{- with .Values.haproxy.networkPolicy.allowedSources }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      # When allowExternal: true, no 'from' clause = allow from ANY source
      # This is the standard Kubernetes pattern for allowing external traffic

    # Allow stats checks
    - ports:
        - port: {{ .Values.haproxy.ports.stats }}
          protocol: TCP
      {{- if not .Values.haproxy.networkPolicy.allowExternal }}
      from:
        {{- with .Values.haproxy.networkPolicy.allowedSources }}
        {{- toYaml . | nindent 8 }}
        {{- else }}
        # Default to same-namespace when no sources specified
        - podSelector: {}
        {{- end }}
      {{- end }}

    # Allow HAProxy Dataplane API access from controller
    - ports:
        - port: {{ .Values.haproxy.ports.dataplane }}
          protocol: TCP
      from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: controller
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: {{ include "haproxy-template-ic.name" . }}

    {{- with .Values.haproxy.networkPolicy.extraIngress }}
    # Additional custom ingress rules
    {{- toYaml . | nindent 4 }}
    {{- end }}

  # Egress rules - what HAProxy can access
  egress:
    # Allow DNS resolution (required for service discovery)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP

    # Allow HAProxy to connect to backend services in any namespace
    # This is required for proxying traffic and performing health checks
    # Uses AND logic: pods in any namespace (not all pods everywhere)
    - to:
        - namespaceSelector: {}
          podSelector: {}

    {{- with .Values.haproxy.networkPolicy.extraEgress }}
    # Additional custom egress rules
    {{- toYaml . | nindent 4 }}
    {{- end }}
{{- end }}
