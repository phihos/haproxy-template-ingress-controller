---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: haproxymapfiles.haproxy-template-ic.github.io
spec:
  group: haproxy-template-ic.github.io
  names:
    kind: HAProxyMapFile
    listKind: HAProxyMapFileList
    plural: haproxymapfiles
    shortNames:
    - hpmap
    singular: haproxymapfile
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.mapName
      name: Map Name
      type: string
    - jsonPath: .spec.path
      name: Path
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          HAProxyMapFile contains a rendered HAProxy map file.

          This is a read-only resource automatically created and updated by the controller
          to expose map files generated from templates. Each HAProxyMapFile is owned by
          a HAProxyConfig resource.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: HAProxyMapFileSpec contains the map file content.
            properties:
              checksum:
                description: |-
                  Checksum is the SHA-256 hash of the map file entries.

                  Used to detect changes and verify consistency across pods.
                  Format: sha256:<hex-digest>
                minLength: 1
                type: string
              entries:
                description: |-
                  Entries is the map file content in HAProxy map format.

                  Each line typically contains a key-value pair separated by whitespace.
                  Example:
                    /api backend-api
                    /web backend-web
                minLength: 1
                type: string
              mapName:
                description: |-
                  MapName is the logical name of the map file.

                  This corresponds to the key in HAProxyTemplateConfig.spec.maps.
                minLength: 1
                type: string
              path:
                description: |-
                  Path is the file system path where this map file is stored.

                  Example: /etc/haproxy/maps/path-prefix.map
                minLength: 1
                type: string
            required:
            - checksum
            - entries
            - mapName
            - path
            type: object
          status:
            description: HAProxyMapFileStatus tracks deployment state to HAProxy pods.
            properties:
              conditions:
                description: |-
                  Conditions represent the latest available observations of the resource's state.

                  Standard conditions include:
                  - "Synced": Map file has been successfully applied to all target pods
                  - "Ready": Resource is ready for use
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              deployedToPods:
                description: |-
                  DeployedToPods tracks which HAProxy pods currently have this map file.

                  Pods are automatically added when the map file is applied and removed when
                  the pod terminates.
                items:
                  description: PodDeploymentStatus tracks deployment to a specific
                    pod.
                  properties:
                    checksum:
                      description: Checksum of the configuration deployed to this
                        pod.
                      type: string
                    consecutiveErrors:
                      description: |-
                        ConsecutiveErrors is the count of consecutive sync failures.

                        This counter increments on each failure and resets to 0 on success.
                        High values indicate persistent problems requiring investigation.
                      minimum: 0
                      type: integer
                    deployedAt:
                      description: |-
                        DeployedAt is the timestamp when configuration was last changed on this pod.

                        This is only updated when actual operations are performed (TotalOperations > 0).
                        To see when config was last verified (including no-op checks), use LastCheckedAt.
                      format: date-time
                      type: string
                    fallbackUsed:
                      description: |-
                        FallbackUsed indicates whether the last sync used fallback mode.

                        When true, indicates that incremental sync failed and a full raw configuration
                        push was used instead. Frequent fallbacks may indicate sync logic issues.
                      type: boolean
                    lastCheckedAt:
                      description: |-
                        LastCheckedAt is the timestamp of the last successful sync operation.

                        Updated on every successful sync (reconciliation or drift-prevention),
                        regardless of whether operations were performed. Use this to verify
                        when the config was last checked against HAProxy's current state.
                      format: date-time
                      type: string
                    lastError:
                      description: |-
                        LastError contains the error message from the most recent failed sync attempt.

                        This field is cleared when a sync succeeds. Combined with ConsecutiveErrors,
                        this helps identify persistent vs transient issues.
                      type: string
                    lastErrorAt:
                      description: |-
                        LastErrorAt is the timestamp of the most recent sync error.

                        Used to determine how long a pod has been in an error state.
                      format: date-time
                      type: string
                    lastOperationSummary:
                      description: |-
                        LastOperationSummary provides a breakdown of operations performed in the last sync.

                        This shows the number of backends, servers, and other resources that were
                        added, removed, or modified during synchronization.
                      properties:
                        backendsAdded:
                          description: BackendsAdded is the number of backends added.
                          minimum: 0
                          type: integer
                        backendsModified:
                          description: BackendsModified is the number of backends
                            modified.
                          minimum: 0
                          type: integer
                        backendsRemoved:
                          description: BackendsRemoved is the number of backends removed.
                          minimum: 0
                          type: integer
                        frontendsAdded:
                          description: FrontendsAdded is the number of frontends added.
                          minimum: 0
                          type: integer
                        frontendsModified:
                          description: FrontendsModified is the number of frontends
                            modified.
                          minimum: 0
                          type: integer
                        frontendsRemoved:
                          description: FrontendsRemoved is the number of frontends
                            removed.
                          minimum: 0
                          type: integer
                        serversAdded:
                          description: ServersAdded is the number of servers added
                            across all backends.
                          minimum: 0
                          type: integer
                        serversModified:
                          description: ServersModified is the number of servers modified
                            across all backends.
                          minimum: 0
                          type: integer
                        serversRemoved:
                          description: ServersRemoved is the number of servers removed
                            across all backends.
                          minimum: 0
                          type: integer
                        totalAPIOperations:
                          description: |-
                            TotalAPIOperations is the total count of HAProxy Dataplane API operations
                            across ALL configuration sections (includes globals, defaults, acls, binds, etc.).

                            This may be higher than the sum of specific operations shown below, as it includes
                            operations on sections not individually tracked in this summary.
                          minimum: 0
                          type: integer
                      type: object
                    lastReloadAt:
                      description: |-
                        LastReloadAt is the timestamp when HAProxy was last reloaded for this pod.

                        HAProxy reloads occur when structural configuration changes are made via
                        the transaction API (status 202). Runtime-only changes do not trigger reloads.
                      format: date-time
                      type: string
                    lastReloadID:
                      description: |-
                        LastReloadID is the reload identifier from the most recent HAProxy reload.

                        This corresponds to the Reload-ID header returned by the HAProxy dataplane
                        API when a reload is triggered.
                      type: string
                    podName:
                      description: PodName is the name of the HAProxy pod.
                      minLength: 1
                      type: string
                    syncDuration:
                      description: |-
                        SyncDuration is the duration of the most recent sync operation.

                        This tracks how long it took to apply configuration changes to this pod,
                        useful for performance monitoring and troubleshooting.
                      type: string
                    versionConflictRetries:
                      description: |-
                        VersionConflictRetries is the number of version conflict retries during the last sync.

                        HAProxy's dataplane API uses optimistic concurrency control. This counter
                        tracks retries due to version conflicts, indicating contention or race conditions.
                      minimum: 0
                      type: integer
                  required:
                  - deployedAt
                  - podName
                  type: object
                type: array
              observedGeneration:
                description: |-
                  ObservedGeneration reflects the generation of the spec that was most recently processed.

                  This is used to track whether status is up-to-date with latest spec changes.
                format: int64
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
