---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: haproxycfgs.haproxy-template-ic.github.io
spec:
  group: haproxy-template-ic.github.io
  names:
    kind: HAProxyCfg
    listKind: HAProxyCfgList
    plural: haproxycfgs
    shortNames:
    - hpcfg
    singular: haproxycfg
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.checksum
      name: Checksum
      type: string
    - jsonPath: .status.metadata.totalSize
      name: Size
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          HAProxyCfg contains the rendered HAProxy configuration for a specific
          HAProxyTemplateConfig.

          This is a read-only resource automatically created and updated by the controller
          to expose the actual runtime configuration applied to HAProxy pods.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: HAProxyCfgSpec contains the rendered configuration content.
            properties:
              checksum:
                description: |-
                  Checksum is the SHA-256 hash of the configuration content.

                  Used to detect configuration changes and verify consistency across pods.
                  Format: sha256:<hex-digest>
                minLength: 1
                type: string
              content:
                description: |-
                  Content is the rendered HAProxy configuration file content.

                  This is the actual haproxy.cfg content that was validated and deployed
                  to HAProxy pods.
                minLength: 1
                type: string
              path:
                description: |-
                  Path is the file system path where this configuration is stored.

                  Default: /etc/haproxy/haproxy.cfg
                minLength: 1
                type: string
            required:
            - checksum
            - content
            - path
            type: object
          status:
            description: HAProxyCfgStatus tracks deployment state and auxiliary files.
            properties:
              auxiliaryFiles:
                description: AuxiliaryFiles references the associated map files and
                  certificates.
                properties:
                  mapFiles:
                    description: MapFiles lists the HAProxyMapFile resources associated
                      with this config.
                    items:
                      description: ResourceReference identifies a related Kubernetes
                        resource.
                      properties:
                        kind:
                          description: Kind is the resource type (e.g., HAProxyMapFile,
                            Secret).
                          minLength: 1
                          type: string
                        name:
                          description: Name is the resource name.
                          minLength: 1
                          type: string
                        namespace:
                          description: Namespace is the resource namespace.
                          type: string
                      required:
                      - kind
                      - name
                      type: object
                    type: array
                  sslCertificates:
                    description: SSLCertificates lists the Secret resources containing
                      SSL certificates.
                    items:
                      description: ResourceReference identifies a related Kubernetes
                        resource.
                      properties:
                        kind:
                          description: Kind is the resource type (e.g., HAProxyMapFile,
                            Secret).
                          minLength: 1
                          type: string
                        name:
                          description: Name is the resource name.
                          minLength: 1
                          type: string
                        namespace:
                          description: Namespace is the resource namespace.
                          type: string
                      required:
                      - kind
                      - name
                      type: object
                    type: array
                type: object
              conditions:
                description: |-
                  Conditions represent the latest available observations of the resource's state.

                  Standard conditions include:
                  - "Synced": Configuration has been successfully applied to all target pods
                  - "Ready": Resource is ready for use
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              deployedToPods:
                description: |-
                  DeployedToPods tracks which HAProxy pods currently have this configuration.

                  Pods are automatically added when configuration is applied and removed when
                  the pod terminates.
                items:
                  description: PodDeploymentStatus tracks deployment to a specific
                    pod.
                  properties:
                    checksum:
                      description: Checksum of the configuration deployed to this
                        pod.
                      type: string
                    consecutiveErrors:
                      description: |-
                        ConsecutiveErrors is the count of consecutive sync failures.

                        This counter increments on each failure and resets to 0 on success.
                        High values indicate persistent problems requiring investigation.
                      minimum: 0
                      type: integer
                    deployedAt:
                      description: |-
                        DeployedAt is the timestamp when configuration was last changed on this pod.

                        This is only updated when actual operations are performed (TotalOperations > 0).
                        To see when config was last verified (including no-op checks), use LastCheckedAt.
                      format: date-time
                      type: string
                    fallbackUsed:
                      description: |-
                        FallbackUsed indicates whether the last sync used fallback mode.

                        When true, indicates that incremental sync failed and a full raw configuration
                        push was used instead. Frequent fallbacks may indicate sync logic issues.
                      type: boolean
                    lastCheckedAt:
                      description: |-
                        LastCheckedAt is the timestamp of the last successful sync operation.

                        Updated on every successful sync (reconciliation or drift-prevention),
                        regardless of whether operations were performed. Use this to verify
                        when the config was last checked against HAProxy's current state.
                      format: date-time
                      type: string
                    lastError:
                      description: |-
                        LastError contains the error message from the most recent failed sync attempt.

                        This field is cleared when a sync succeeds. Combined with ConsecutiveErrors,
                        this helps identify persistent vs transient issues.
                      type: string
                    lastErrorAt:
                      description: |-
                        LastErrorAt is the timestamp of the most recent sync error.

                        Used to determine how long a pod has been in an error state.
                      format: date-time
                      type: string
                    lastOperationSummary:
                      description: |-
                        LastOperationSummary provides a breakdown of operations performed in the last sync.

                        This shows the number of backends, servers, and other resources that were
                        added, removed, or modified during synchronization.
                      properties:
                        backendsAdded:
                          description: BackendsAdded is the number of backends added.
                          minimum: 0
                          type: integer
                        backendsModified:
                          description: BackendsModified is the number of backends
                            modified.
                          minimum: 0
                          type: integer
                        backendsRemoved:
                          description: BackendsRemoved is the number of backends removed.
                          minimum: 0
                          type: integer
                        frontendsAdded:
                          description: FrontendsAdded is the number of frontends added.
                          minimum: 0
                          type: integer
                        frontendsModified:
                          description: FrontendsModified is the number of frontends
                            modified.
                          minimum: 0
                          type: integer
                        frontendsRemoved:
                          description: FrontendsRemoved is the number of frontends
                            removed.
                          minimum: 0
                          type: integer
                        serversAdded:
                          description: ServersAdded is the number of servers added
                            across all backends.
                          minimum: 0
                          type: integer
                        serversModified:
                          description: ServersModified is the number of servers modified
                            across all backends.
                          minimum: 0
                          type: integer
                        serversRemoved:
                          description: ServersRemoved is the number of servers removed
                            across all backends.
                          minimum: 0
                          type: integer
                        totalAPIOperations:
                          description: |-
                            TotalAPIOperations is the total count of HAProxy Dataplane API operations
                            across ALL configuration sections (includes globals, defaults, acls, binds, etc.).

                            This may be higher than the sum of specific operations shown below, as it includes
                            operations on sections not individually tracked in this summary.
                          minimum: 0
                          type: integer
                      type: object
                    lastReloadAt:
                      description: |-
                        LastReloadAt is the timestamp when HAProxy was last reloaded for this pod.

                        HAProxy reloads occur when structural configuration changes are made via
                        the transaction API (status 202). Runtime-only changes do not trigger reloads.
                      format: date-time
                      type: string
                    lastReloadID:
                      description: |-
                        LastReloadID is the reload identifier from the most recent HAProxy reload.

                        This corresponds to the Reload-ID header returned by the HAProxy dataplane
                        API when a reload is triggered.
                      type: string
                    podName:
                      description: PodName is the name of the HAProxy pod.
                      minLength: 1
                      type: string
                    syncDuration:
                      description: |-
                        SyncDuration is the duration of the most recent sync operation.

                        This tracks how long it took to apply configuration changes to this pod,
                        useful for performance monitoring and troubleshooting.
                      type: string
                    versionConflictRetries:
                      description: |-
                        VersionConflictRetries is the number of version conflict retries during the last sync.

                        HAProxy's dataplane API uses optimistic concurrency control. This counter
                        tracks retries due to version conflicts, indicating contention or race conditions.
                      minimum: 0
                      type: integer
                  required:
                  - deployedAt
                  - podName
                  type: object
                type: array
              metadata:
                description: Metadata contains information about the configuration
                  rendering and validation.
                properties:
                  contentSize:
                    description: ContentSize is the size of the main configuration
                      content in bytes.
                    format: int64
                    minimum: 0
                    type: integer
                  renderedAt:
                    description: RenderedAt is the timestamp when the configuration
                      was rendered.
                    format: date-time
                    type: string
                  totalSize:
                    description: |-
                      TotalSize is the total size of all configuration data in bytes.

                      Includes main config, map files, and certificates.
                    format: int64
                    minimum: 0
                    type: integer
                  validatedAt:
                    description: ValidatedAt is the timestamp when the configuration
                      was successfully validated.
                    format: date-time
                    type: string
                type: object
              observedGeneration:
                description: |-
                  ObservedGeneration reflects the generation of the spec that was most recently processed.

                  This is used to track whether status is up-to-date with latest spec changes.
                format: int64
                type: integer
              validationError:
                description: |-
                  ValidationError contains the error message if this configuration failed validation.

                  Only populated for HAProxyCfg resources published with the -invalid suffix.
                  When present, this configuration was not deployed to HAProxy instances.
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
